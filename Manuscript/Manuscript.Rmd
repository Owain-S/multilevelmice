---
documentclass: jss
author:
  - name: Hanne Oberman
    affiliation: Utrecht University
    address: |
      | Padualaan 14
      | 3584 CH Utrecht
    email: \email{h.i.oberman@uu.nl}
    url: https://hanneoberman.github.io/
  - name: Johanna Munoz Avila
    affiliation: University Medical Center Utrecht \AND
  - name: Valentijn de Jong
    affiliation: University Medical Center Utrecht 
  - name: Gerko Vink
    affiliation: Utrecht University \AND
  - name: Thomas Debray
    affiliation: University Medical Center Utrecht 
      # | Julius Center for Health Sciences and Primary Care, 
      # | University Medical Center Utrecht, Utrecht, The Netherlands
    #affiliation2:
title:
  formatted: "Imputation of Incomplete Multilevel Data with \\pkg{mice}"
  # If you use tex in the formatted title, also supply version without
  plain:     "Imputation of Incomplete Multilevel Data with mice"
  # For running headers, if needed
  short:     "\\pkg{mice}: Multilevel"
abstract: >
  Tutorial paper on imputing incomplete multilevel data with \pkg{mice}. Including methods for ignorable and non-ignorable missingness. 
keywords:
  # at least one keyword must be supplied
  formatted: [missing data, multilevel, clustering, "\\pkg{mice}", "\\proglang{R}"]
  plain:     [missing data, multilevel, clustering, mice, R]
preamble: >
  \usepackage{amsmath}
output: rticles::jss_article
bibliography: ../References/multilevelmice.bib
---

```{r, setup, include=FALSE}
options(prompt = 'R> ', continue = '+ ')

# packages
library(tidyverse)
library(mice)
library(miceadds)
library(metamisc)
library(pan)

# functions
miceadds::source.all(path = "../R")

# plot parameters
plot_col <- mice:::mdc(1:2) %>% setNames(c("observed", "missing"))
```

# Introduction

## Multilevel data

- What is clustering/multilevel data? In this paper, we discuss grouped observations, not longitudinal data (within-patient clustering).  -> ADD: timeseries also in Discussion section.

- What do we mean by clustering? In the medical field: Clustering by studies (IPDMA), hospitals in registries, multi-center studies etc. In other fields: e.g. official stats clustering at country-level, or social sciences clustering at school-level (related to the sampling design).

- What is heterogeneity? I.e. variability within studies vs. variability between studies

- What does multilevel data look like? ADD: figure to show difference between patient-level datapoints vs cluster-level datapoints. Maybe also add different data frame formats (or just explain in text that there's long and wide formats).

- What methods are required to analyze multilevel data?	Add references, e.g. @hox17 and @jong21. At least explain difference random effects for intercept term, predictor effects, and/or variance residual error. 

## Missing data

- Why/where does missingness occur in multilevel data? I.e., not only patient-level but also cluster-level.

- How can we categorize this? Systematic vs sporadic missingness, see @resc13. ADD: visualization of systematic vs sporadic missingness. Within systematic we have always missing (same value per cluster) and non-measured variables (may differ per patient). TODO: adjust md pattern to match text. -> syst may vary or same for all patients (observations/participants).

```{r patterns, echo=FALSE}
# monotone vs non-monotone
patterns <- rbind(
  tibble(
    pat = rep("systematic", 5),
    rownr = 5:1,
    X1 = rep("observed", 5),
    X2 = c(rep("observed", 3), rep("missing", 2)),
    X3 = c(rep("missing", 3),  rep("observed", 2))
  ) %>% pivot_longer(cols = c(X1, X2, X3)),
  tibble(
    pat = rep("sporadic", 5),
    rownr = 5:1,
    X1 = c("observed", "missing", rep("observed", 3)),
    X2 = c(rep("observed", 2), rep("missing", 3)),
    X3 = c(rep("missing", 3),  rep("observed", 2))
  ) %>% pivot_longer(cols = c(X1, X2, X3))
) %>%
  mutate(across(everything(), as.factor),
         pat = factor(pat, levels = c("systematic", "sporadic"), labels = c("Systematic missingness", "Sporadic missingness"), ordered = TRUE))
# plot
ggplot(patterns, aes(
  x = name,
  y = rownr,
  fill = value,
  type = pat
)) +
  geom_tile(color = "black") +
  scale_y_discrete(labels = c(2, 2, 1, 1, 1)) +
  scale_fill_manual(values = plot_col, name = "Datapoint") +
  facet_wrap( ~ pat, ncol = 2) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Variable", y = "Cluster")
```

-	What kinds of missingness are there? ADD: missingness mechanisms here. See e.g. @yuce08 and @hox15.

- Why are standard (ad hoc) missing data methods not well suited? 

- What types of multilevel methods are available? General overview of approaches, see @audi18 and @grun18. E.g., imputation of study level versus patient-level covariates, and one-stage imputation versus two-stage imputation methods.

- Additional difficulty that is addressed in this tutorial: MNAR data.


## Aim of this paper

- Provide practical guidelines with code snippets for imputation of incomplete multilevel data. 

- We focus on the workflow for conditional modeling (not JOMO) in `mice`. Refer to other packages: `mitml`, `miceadds`, `mdmb`.

- Case study options: `metamisc::impact` (real IPD on traumatic brain injuries, without `NA`s), `mice::popularity` (simulated data on school kids, with MNAR/MAR mixture). TODO: Check example data Gelman.

- Introduce case study and set scope of this tutorial: We're providing an overview of implementations. It's up-to the reader to decide which strategy suits their data. So we won't go into detail for the different methods (and equations). This paper is just a software tutorial. We'll keep it practical. -> ADD: some kind of help function that suggests a suitable predictor matrix to the user, given a certain analysis model.


# Workflows

We'll use the IMPACT data (`metamisc::impact`) and a MAR/MNAR version of the `mice::popmis` data (i.e., a variation on the Hox (2010) popularity data, where the missingness in the variables is either missing at random (MAR) or missing not at random (MNAR)).


## Case study I: IMPACT


`impact` is traumatic brain injury data with patients clustered in studies, $n_{\text{participants}} = 11022$ and $n_{\text{clusters}} = 15$, on the following 11 variables:
    * `name` Name of the study,
    * `type` Type of study (RCT: randomized controlled trial, OBS: observational cohort),
    * `age` Age of the patient,
    * `motor_score` Glasgow Coma Scale motor score,
    * `pupil` Pupillary reactivity,
    * `ct` Marshall Computerized Tomography classification,
    * `hypox` Hypoxia (0=no, 1=yes),
    * `hypots` Hypotension (0=no, 1=yes),
    * `tsah` Traumatic subarachnoid hemorrhage (0=no, 1=yes),
    * `edh` Epidural hematoma (0=no, 1=yes),
    * `mort` 6-month mortality (0=alive, 1=dead).


```{r impact}
# load data
data("impact")
# # descriptive statistics
# by(impact, impact$name, summary) 
# psych::describe(impact)[,c(2:5,8:9)]
# missingness
md_pat(impact)
```
-> Why are there no missings? According to the [vignette](https://cran.r-project.org/web/packages/metamisc/metamisc.pdf), the data is already imputed (Steyerberg et al, 2008).


## Case Study II: Popularity

`popNCR` is a simulated dataset with pupils clustered in classes, $n_{\text{participants}} = 2000$, $n_{\text{clusters}} = 100$, on 7 variables: 
    * `pupil`	Pupil number within class,
    * `class`	Class number,
    * `extrav`	Pupil extraversion,
    * `sex`	Pupil gender,
    * `texp`	Teacher experience (years),
    * `popular`	Pupil popularity,
    * `popteach`	Teacher popularity.

```{r pop}
# load data
pop <- readRDS("../Data/popNCR.RDS")
# missingness
md_pat(pop)
```


## Modeling choices

- Which models will we discuss? We'll build the model to grow in complexity. The final model is the most complex but also the most versatile. 

- Note on model complexity: Typically, we should at least use random intercepts, but often random slopes as well. Ideally we impute with random everything and heteroscedastic errors: most generic method (no worry about congeniality, but don't mention the term) ->  Refer to other papers for background, we'll focus just on the software implementation of the situations mentioned there. Sometimes there's little reason to assume some variable is affected by heterogeneity. -> Refer to Meng, Vincent, and a paper by Grund on congeniality and random slopes. 

- Step 0: study as a predictor, AKA multilevel imputation for dummies. Doesn't work for syst missing. 

## Conditional models

- How to define the imputation model(s) in `mice`?

- What do the different implementations look like?

- Step 1: Intercept

- Step 2: Slope

- Step 3: Residuals

- Heckman model for MNAR


## Pooling

- Analysis of scientific interest.

- Pooling using `mitml`.

- Pooling 'regular' parameters vs more 'exotic' parameters (SE of residual errors, or autocorrelation) 

- ADD: export `mids` objects to other packages like `lme4` or `coxme`? 


# Discussion

- JOMO in `mice` --> on the side for now

- Additional levels of clustering

- Timeseries: and polynomial relationship in the clustering.


# References

