---
documentclass: jss
author:
  - name: Hanne Oberman
    affiliation: Utrecht University
    address: |
      | Padualaan 14
      | 3584 CH Utrecht
    email: \email{h.i.oberman@uu.nl}
    url: https://hanneoberman.github.io/
  - name: Johanna Munoz Avila
    affiliation: University Medical Center Utrecht
  - name: Valentijn
    affiliation: University Medical Center Utrecht \AND
  - name: Gerko Vink
    affiliation: Utrecht University
  - name: Thomas Debray
    affiliation: University Medical Center Utrecht 
      # | Julius Center for Health Sciences and Primary Care, 
      # | University Medical Center Utrecht, Utrecht, The Netherlands
    #affiliation2:
title:
  formatted: "Imputation of Incomplete Multilevel Data with \\pkg{mice}"
  # If you use tex in the formatted title, also supply version without
  plain:     "Imputation of Incomplete Multilevel Data with mice"
  # For running headers, if needed
  short:     "\\pkg{mice}: Multilevel"
abstract: >
  Tutorial paper on imputing incomplete multilevel data with \pkg{mice}. Including methods for ignorable and non-ignorable missingness. AKA missing on so many levels.
keywords:
  # at least one keyword must be supplied
  formatted: [missing data, multilevel, clustering, "\\proglang{R}"]
  plain:     [missing data, multilevel, clustering, R]
preamble: >
  \usepackage{amsmath}
output: rticles::jss_article
bibliography: ../References/multilevelmice.bib
---

```{r, setup, include=FALSE}
options(prompt = 'R> ', continue = '+ ')
library(tidyverse)

```

# Introduction

## Multilevel data

- What is clustering/multilevel data? In this paper, we discuss grouped observations, not longitudinal data (within-patient clustering). What do we mean by clustering? In the medical field: Clustering by studies (IPDMA), hospitals in registries, multi-center studies etc. In other fields: e.g. official stats clustering at country-level, or social sciences clustering at school-level (related to the sampling design).

- What is heterogeniety (i.e. variability within studies vs. variability between studies)? ADD: Figure to show difference between patient-level datapoints vs cluster-level datapoints. And different data frame formats.

- What methods are required to analyze multilevel data?	Random effects for intercept term, predictor effects, and/or variance residual error. Add references, e.g. @hox17.

## Missing data

- Why/where does missingness occur? I.e., not only patient-level but also cluster-level.

- How can we categorize this? Systematic vs sporadic missingness, see @resc13. ADD: visualization of systematic vs sporadic missingness. Within systematic we have always missing (same value per cluster) and non-measured variables (may differ per patient). TODO: adjust md pattern to match text.

```{r patterns, echo=FALSE}
# monotone vs non-monotone
patterns <- rbind(
  tibble(pat = rep("Monotone", 5), rownr = 5:1, X = rep(1, 5), Y = c(1,1,1,0, 0), Z = c(1, rep(0,4))) %>% pivot_longer(cols = c(X, Y, Z)),
  tibble(pat = rep("Non-monotone", 5), rownr = 5:1, X = c(0, rep(1,4)), Y = c(1,1,1,0, 0), Z = c(1, rep(0,3), 1)) %>% pivot_longer(cols = c(X, Y, Z))) %>%
  mutate(across(everything(), as.factor))
ggplot(patterns, aes(x = name, y = rownr, fill = value, type = pat)) +
  geom_tile(color = "black") +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~pat) +
  theme_void() +
  theme(legend.position = "none") 
```

-	Why are standard (ad hoc) missing data methods not well suited? 

- What other methods are available? General overview of approaches, see @audi18 @grun18. E.g., imputation of study level versus patient-level covariates, and one-stage imputation versus two-stage imputation methods.

-	Additional problem addressed in this paper: handling MNAR.


## Aim of this paper

- Provide practical guidelines with code snippets for imputation of incomplete multilevel data.

- Case study options: metamisc::impact (IPD), GREAT (IPD).


# Workflows

## Modeling choices

- ADD: Section with more in-depth info on different data types and suitable methods. Add some equations, but not too much -> grow in complexity.

- Ideally we impute with random everything and heteroscedastic errors: most generic method (no worry about congeneiality) --> explain predictor matrix. Just mention that we should think about random intercept/slope, but just refer to other papers. This paper is just a software tutorial. --> Typically, at least random intercepts, but often random slopes as well. Refer to other papers for background, we'll focus just on the software implementation of the situations mentioned there. Sometimes there's little reason to assume some variable is affected by heterogeniety. We won't focus on congeneiality, that's too complex for 2-3 papers.


## Conditional models

- How to define the imputation model(s) in mice?

- What do the different implementations look like?


## Pooling

- Pooling 'regular' parameters vs more 'exotic' parameters (SE of residual errors, or autocorreletion) 

- ADD: export mids objects to other packages like lme4 or coxme(?) 


# Think about adding

- JOMO in mice --> on the side for now

- Additional levels of clustering



# References

